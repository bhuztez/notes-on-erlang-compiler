========================
Notes on Erlang Compiler
========================


erlc
====

:code:`erts/etc/common/erlc.c`

:code:`erlc` is equivalent to

.. code::

    beam +sbtu +A0 -noinput -mode minimal -boot start_clean -s erl_compile compile_cmdline -extra


erl_compile
===========

:code:`lib/stdlib/src/erl_compile.erl` 

select different passes for different filename extension

.. code::

   compiler(".erl") ->    {compile,         compile};
   compiler(".S") ->      {compile,         compile_asm};
   compiler(".beam") ->   {compile,         compile_beam};
   compiler(".core") ->   {compile,         compile_core};


+----------+--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
| passes   | pass                     | function                             | erlc                 | extension           | format              |                         |
+==========+==========================+======================================+======================+=====================+=====================+=========================+
| Standard | parse_module             | :code:`epp:parse_file/2`             |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | transform_module         |                                      |                      |                     |                     | :code:`parse_transform` |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | makedep                  |                                      | :code:`-M`           |                     | Makefile            |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          |                          |                                      | :code:`+dpp`         | :code:`.pp`         | Erlang Form Terms   | before lint             |
|          |                          |                                      +----------------------+---------------------+---------------------+-------------------------+
|          | lint_module              |                                      | :code:`-P`           | :code:`.P`          | Erlang Code         |                         |
|          |                          |                                      +----------------------+---------------------+---------------------+-------------------------+
|          |                          |                                      | :code:`+to_pp`       | :code:`.P`          | Erlang Form Terms   |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | save_abstract_code       |                                      | :code:`+dabstr`      | :code:`.abstr`      | Erlang Form Terms   |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          |                          |                                      | :code:`+dexp`        | :code:`.expand`     | Erlang Form Terms   | add two function        |
|          |                          |                                      +----------------------+---------------------+---------------------+ :code:`module_info/0`   |
|          | expand_module            | :code:`sys_pre_expand:module/2`      | :code:`-E`           | :code:`.E`          | Erlang Code         | :code:`module_info/1`   |
|          |                          |                                      +----------------------+---------------------+---------------------+ to module               |
|          |                          |                                      | :code:`+to_exp`      | :code:`.E`          | Erlang Form Terms   |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          |                          |                                      | :code:`+dcore`       | :code:`.core`       | Core Erlang Code    |                         |
|          | core_module              | :code:`v3_core:module/2`             +----------------------+---------------------+---------------------+                         |
|          |                          |                                      | :code:`+to_core0`    | :code:`.core`       | Core Erlang Code    |                         |
+----------+--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
| Core     | parse_core               | :code:`core_scan:string/1`,          |                      |                     |                     |                         |
|          |                          | :code:`core_parse:parse/1`           |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | core_lint_module         | :code:`core_lint:module/2`           |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | core_old_inliner         | :code:`sys_core_inline:module/2`     | :code:`+doldinline`  | :code:`.oldinline`  | Core Erlang Code    |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | core_fold_module         | :code:`sys_core_fold:module/2`       | :code:`+dcorefold`   | :code:`.corefold`   | Core Erlang Code    |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | core_inline_module       | :code:`cerl_inline:core_transform/2` | :code:`+inline`      | :code:`.inline`     | Core Erlang Code    |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | core_fold_after_inlining | :code:`sys_core_fold:module/2`       |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          |                          |                                      | :code:`+dcopt`       | :code:`.copt`       | Core Erlang Code    | :code:`core_transform`  |
|          | core_transforms          |                                      +----------------------+---------------------+---------------------+                         |
|          |                          |                                      | :code:`to_core`      | :code:`.core`       | Core Erlang Code    |                         |
+----------+--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
| Kernel   | core_dsetel_module       | :code:`sys_core_dsetel:module/2`     | :code:`+dsetel`      | :code:`.dsetel`     | Core Erlang Code    |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | core_lint_module         |                                      |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | save_core_code           |                                      |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          |                          |                                      | :code:`+dkern`       | :code:`.kernel`     | Kernel Erlang Code  |                         |
|          | kernel_module            | :code:`v3_kernel:module/2`           +----------------------+---------------------+---------------------+                         |
|          |                          |                                      | :code:`+to_kernel`   | :code:`.kernel`     | Kernel Erlang Code  |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | v3_life                  | :code:`v3_life:module/2`             | :code:`+dlife`       | :code:`.life`       | Kernel Erlang Code  | annotated with life     |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | v3_codegen               | :code:`v3_codegen:module/2`          | :code:`+dcg`         | :code:`.codegen`    | Assembly Terms      |                         |
+----------+--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
| ASM      | beam_consult_asm         |                                      |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_a                   | :code:`beam_a:module/2`              |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_block               | :code:`beam_block:module/2`          | :code:`+dblk`        | :code:`.block`      | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_except              | :code:`beam_except:module/2`         | :code:`+dexcept`     | :code:`.except`     | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_bool                | :code:`beam_bool:module/2`           | :code:`+dbool`       | :code:`.bool`       | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_type                | :code:`beam_type:module/2`           | :code:`+dtype`       | :code:`.type`       | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_split               | :code:`beam_split:module/2`          | :code:`+dsplit`      | :code:`.split`      | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_dead                | :code:`beam_dead:module/2`           | :code:`+ddead`       | :code:`.dead`       | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_jump                | :code:`beam_jump:module/2`           | :code:`+djmp`        | :code:`.jump`       | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_peep                | :code:`beam_peep:module/2`           | :code:`+dpeep`       | :code:`.peep`       | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_clean               | :code:`beam_clean:module/2`          | :code:`+dclean`      | :code:`.clean`      | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_bsm                 | :code:`beam_bsm:module/2`            | :code:`+dbsm`        | :code:`.bsm`        | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_receive             | :code:`beam_receive:module/2`        | :code:`+drecv`       | :code:`.recv`       | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_trim                | :code:`beam_trim:module/2`           | :code:`+dtrim`       | :code:`.trim`       | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_flatten             | :code:`beam_flatten:module/2`        |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          |                          |                                      | :code:`+dopt`        | :code:`.optimize`   | Assembly Terms      |                         |
|          |                          |                                      +----------------------+---------------------+---------------------+                         |
|          | beam_z                   | :code:`beam_z:module/2`              | :code:`-S`           | :code:`.S`          | Assembly Terms      |                         |
|          |                          |                                      +----------------------+---------------------+---------------------+                         |
|          |                          |                                      | :code:`+to_asm`      | :code:`.S`          | Assembly Terms      |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_validator           | :code:`beam_validator:module/2`      |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | beam_asm                 | :code:`beam_asm:module/2`            |                      |                     |                     |                         |
+----------+--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
| Binary   | read_beam_file           |                                      |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | native_compile           | :code:`hipe:compile/4`               |                      |                     |                     |                         |
|          +--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+
|          | save_binary              |                                      |                      |                     |                     |                         |
+----------+--------------------------+--------------------------------------+----------------------+---------------------+---------------------+-------------------------+


HiPE
====

To get Icode of Erlang code

.. code::

    {ok,_,Bin}=compile:file(FileName,[binary]).
    {beam_file,_,_,_,_,BeamCode}=beam_disasm:file(Bin).
    [{{M,F,A},Icode}|_]=hipe_beam_to_icode:module(BeamCode,[]).


Icode
-----


RTL
---
